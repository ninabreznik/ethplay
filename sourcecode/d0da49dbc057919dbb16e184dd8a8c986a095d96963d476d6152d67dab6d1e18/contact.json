{
  "address": "0x2791528f5617e187a6d73c30034ac211b2f47042",
  "chain": "ETH",
  "chainID": 1,
  "verifier": "etherscan.io",
  "commonName": "",
  "contractName": "CardsRaffle",
  "compilerVersion": "v0.4.21+commit.dfe3193c",
  "optimization": true,
  "runs": "200",
  "evmVersion": "default",
  "sourceCode": "/**\n *Submitted for verification at Etherscan.io on 2018-07-26\n*/\n\npragma solidity ^0.4.18;\n/* ==================================================================== */\n/* Copyright (c) 2018 The MagicAcademy Project.  All rights reserved.\n/* \n/* https://www.magicacademy.io One of the world's first idle strategy games of blockchain \n/*  \n/* authors [email protected]/[email protected]\n/*                 \n/* ==================================================================== */\n/**\n * @title Ownable\n * @dev The Ownable contract has an owner address, and provides basic authorization control\n * functions, this simplifies the implementation of \"user permissions\".\n */\ncontract Ownable {\n  address public owner;\n\n  event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);\n\n  /*\n   * @dev The Ownable constructor sets the original `owner` of the contract to the sender\n   * account.\n   */\n  function Ownable() public {\n    owner = msg.sender;\n  }\n\n  /**\n   * @dev Throws if called by any account other than the owner.\n   */\n  modifier onlyOwner() {\n    require(msg.sender == owner);\n    _;\n  }\n\n  /**\n   * @dev Allows the current owner to transfer control of the contract to a newOwner.\n   * @param newOwner The address to transfer ownership to.\n   */\n  function transferOwnership(address newOwner) public onlyOwner {\n    require(newOwner != address(0));\n    OwnershipTransferred(owner, newOwner);\n    owner = newOwner;\n  }\n}\n\ncontract AccessAdmin is Ownable {\n\n  /// @dev Admin Address\n  mapping (address => bool) adminContracts;\n\n  /// @dev Trust contract\n  mapping (address => bool) actionContracts;\n\n  function setAdminContract(address _addr, bool _useful) public onlyOwner {\n    require(_addr != address(0));\n    adminContracts[_addr] = _useful;\n  }\n\n  modifier onlyAdmin {\n    require(adminContracts[msg.sender]); \n    _;\n  }\n\n  function setActionContract(address _actionAddr, bool _useful) public onlyAdmin {\n    actionContracts[_actionAddr] = _useful;\n  }\n\n  modifier onlyAccess() {\n    require(actionContracts[msg.sender]);\n    _;\n  }\n}\n\ninterface CardsInterface {\n  function balanceOf(address player) public constant returns(uint256);\n  function updatePlayersCoinByOut(address player) external;\n  function updatePlayersCoinByPurchase(address player, uint256 purchaseCost) public;\n  function removeUnitMultipliers(address player, uint256 upgradeClass, uint256 unitId, uint256 upgradeValue) external;\n  function upgradeUnitMultipliers(address player, uint256 upgradeClass, uint256 unitId, uint256 upgradeValue) external;\n}\ninterface RareInterface {\n  function getRareItemsOwner(uint256 rareId) external view returns (address);\n  function getRareItemsPrice(uint256 rareId) external view returns (uint256);\n    function getRareInfo(uint256 _tokenId) external view returns (\n    uint256 sellingPrice,\n    address owner,\n    uint256 nextPrice,\n    uint256 rareClass,\n    uint256 cardId,\n    uint256 rareValue\n  ); \n  function transferToken(address _from, address _to, uint256 _tokenId) external;\n  function transferTokenByContract(uint256 _tokenId,address _to) external;\n  function setRarePrice(uint256 _rareId, uint256 _price) external;\n  function rareStartPrice() external view returns (uint256);\n}\ncontract CardsRaffle is AccessAdmin {\n  using SafeMath for SafeMath;\n\n  function CardsRaffle() public {\n    setAdminContract(msg.sender,true);\n    setActionContract(msg.sender,true);\n  }\n  //data contract\n  CardsInterface public cards ;\n  RareInterface public rare;\n\n  function setCardsAddress(address _address) external onlyOwner {\n    cards = CardsInterface(_address);\n  }\n\n  //rare cards\n  function setRareAddress(address _address) external onlyOwner {\n    rare = RareInterface(_address);\n  }\n\n  function getRareAddress() public view returns (address) {\n    return rare;\n  }\n\n  //event\n  event UnitBought(address player, uint256 unitId, uint256 amount);\n  event RaffleSuccessful(address winner);\n\n  // Raffle structures\n  struct TicketPurchases {\n    TicketPurchase[] ticketsBought;\n    uint256 numPurchases; // Allows us to reset without clearing TicketPurchase[] (avoids potential for gas limit)\n    uint256 raffleRareId;\n  }\n    \n  // Allows us to query winner without looping (avoiding potential for gas limit)\n  struct TicketPurchase {\n    uint256 startId;\n    uint256 endId;\n  }\n    \n  // Raffle tickets\n  mapping(address => TicketPurchases) private ticketsBoughtByPlayer;\n  mapping(uint256 => address[]) private rafflePlayers; // Keeping a seperate list for each raffle has it's benefits. \n\n  uint256 private constant RAFFLE_TICKET_BASE_PRICE = 10000;\n\n  // Current raffle info  \n  uint256 private raffleEndTime;\n  uint256 private raffleRareId;\n  uint256 private raffleTicketsBought;\n  address private raffleWinner; // Address of winner\n  bool private raffleWinningTicketSelected;\n  uint256 private raffleTicketThatWon;\n\n  // Raffle for rare items  \n  function buyRaffleTicket(uint256 amount) external {\n    require(raffleEndTime >= block.timestamp);  //close it if need test\n    require(amount > 0);\n        \n    uint256 ticketsCost = SafeMath.mul(RAFFLE_TICKET_BASE_PRICE, amount);\n    require(cards.balanceOf(msg.sender) >= ticketsCost);\n        \n    // Update player's jade  \n    cards.updatePlayersCoinByPurchase(msg.sender, ticketsCost);\n        \n    // Handle new tickets\n    TicketPurchases storage purchases = ticketsBoughtByPlayer[msg.sender];\n        \n    // If we need to reset tickets from a previous raffle\n    if (purchases.raffleRareId != raffleRareId) {\n      purchases.numPurchases = 0;\n      purchases.raffleRareId = raffleRareId;\n      rafflePlayers[raffleRareId].push(msg.sender); // Add user to raffle\n    }\n        \n    // Store new ticket purchase \n    if (purchases.numPurchases == purchases.ticketsBought.length) {\n      purchases.ticketsBought.length = SafeMath.add(purchases.ticketsBought.length,1);\n    }\n    purchases.ticketsBought[purchases.numPurchases++] = TicketPurchase(raffleTicketsBought, raffleTicketsBought + (amount - 1)); // (eg: buy 10, get id's 0-9)\n        \n    // Finally update ticket total\n    raffleTicketsBought = SafeMath.add(raffleTicketsBought,amount);\n    //event\n    UnitBought(msg.sender,raffleRareId,amount);\n  } \n\n  /// @dev start raffle\n  function startRareRaffle(uint256 endTime, uint256 rareId) external onlyAdmin {\n    require(rareId>0);\n    require(rare.getRareItemsOwner(rareId) == getRareAddress());\n    require(block.timestamp < endTime); //close it if need test\n\n    if (raffleRareId != 0) { // Sanity to assure raffle has ended before next one starts\n      require(raffleWinner != 0);\n    }\n\n    // Reset previous raffle info\n    raffleWinningTicketSelected = false;\n    raffleTicketThatWon = 0;\n    raffleWinner = 0;\n    raffleTicketsBought = 0;\n        \n    // Set current raffle info\n    raffleEndTime = endTime;\n    raffleRareId = rareId;\n  }\n\n  function awardRafflePrize(address checkWinner, uint256 checkIndex) external { \n    require(raffleEndTime < block.timestamp);  //close it if need test\n    require(raffleWinner == 0);\n    require(rare.getRareItemsOwner(raffleRareId) == getRareAddress());\n        \n    if (!raffleWinningTicketSelected) {\n      drawRandomWinner(); // Ideally do it in one call (gas limit cautious)\n    }\n        \n  // Reduce gas by (optionally) offering an address to _check_ for winner\n    if (checkWinner != 0) {\n      TicketPurchases storage tickets = ticketsBoughtByPlayer[checkWinner];\n      if (tickets.numPurchases > 0 && checkIndex < tickets.numPurchases && tickets.raffleRareId == raffleRareId) {\n        TicketPurchase storage checkTicket = tickets.ticketsBought[checkIndex];\n        if (raffleTicketThatWon >= checkTicket.startId && raffleTicketThatWon <= checkTicket.endId) {\n          assignRafflePrize(checkWinner); // WINNER!\n          return;\n        }\n      }\n    }\n        \n  // Otherwise just naively try to find the winner (will work until mass amounts of players)\n    for (uint256 i = 0; i < rafflePlayers[raffleRareId].length; i++) {\n      address player = rafflePlayers[raffleRareId][i];\n      TicketPurchases storage playersTickets = ticketsBoughtByPlayer[player];\n            \n      uint256 endIndex = playersTickets.numPurchases - 1;\n      // Minor optimization to avoid checking every single player\n      if (raffleTicketThatWon >= playersTickets.ticketsBought[0].startId && raffleTicketThatWon <= playersTickets.ticketsBought[endIndex].endId) {\n        for (uint256 j = 0; j < playersTickets.numPurchases; j++) {\n          TicketPurchase storage playerTicket = playersTickets.ticketsBought[j];\n          if (raffleTicketThatWon >= playerTicket.startId && raffleTicketThatWon <= playerTicket.endId) {\n            assignRafflePrize(player); // WINNER!\n            return;\n          }\n        }\n      }\n    }\n  }\n\n  function assignRafflePrize(address winner) internal {\n    raffleWinner = winner;\n    uint256 newPrice = (rare.rareStartPrice() * 25) / 20;\n    rare.transferTokenByContract(raffleRareId,winner);\n    rare.setRarePrice(raffleRareId,newPrice);\n       \n    cards.updatePlayersCoinByOut(winner);\n    uint256 upgradeClass;\n    uint256 unitId;\n    uint256 upgradeValue;\n    (,,,,upgradeClass, unitId, upgradeValue) = rare.getRareInfo(raffleRareId);\n    \n    cards.upgradeUnitMultipliers(winner, upgradeClass, unitId, upgradeValue);\n    //event\n    RaffleSuccessful(winner);\n  }\n  \n  // Random enough for small contests (Owner only to prevent trial & error execution)\n  function drawRandomWinner() public onlyAdmin {\n    require(raffleEndTime < block.timestamp); //close it if need to test\n    require(!raffleWinningTicketSelected);\n        \n    uint256 seed = SafeMath.add(raffleTicketsBought , block.timestamp);\n    raffleTicketThatWon = addmod(uint256(block.blockhash(block.number-1)), seed, raffleTicketsBought);\n    raffleWinningTicketSelected = true;\n  }  \n\n  // To allow clients to verify contestants\n  function getRafflePlayers(uint256 raffleId) external constant returns (address[]) {\n    return (rafflePlayers[raffleId]);\n  }\n\n    // To allow clients to verify contestants\n  function getPlayersTickets(address player) external constant returns (uint256[], uint256[]) {\n    TicketPurchases storage playersTickets = ticketsBoughtByPlayer[player];\n        \n    if (playersTickets.raffleRareId == raffleRareId) {\n      uint256[] memory startIds = new uint256[](playersTickets.numPurchases);\n      uint256[] memory endIds = new uint256[](playersTickets.numPurchases);\n            \n      for (uint256 i = 0; i < playersTickets.numPurchases; i++) {\n        startIds[i] = playersTickets.ticketsBought[i].startId;\n        endIds[i] = playersTickets.ticketsBought[i].endId;\n      }\n    }\n        \n    return (startIds, endIds);\n  }\n\n\n  // To display on website\n  function getLatestRaffleInfo() external constant returns (uint256, uint256, uint256, address, uint256) {\n    return (raffleEndTime, raffleRareId, raffleTicketsBought, raffleWinner, raffleTicketThatWon);\n  }    \n}\n\nlibrary SafeMath {\n\n  /**\n  * @dev Multiplies two numbers, throws on overflow.\n  */\n  function mul(uint256 a, uint256 b) internal pure returns (uint256) {\n    if (a == 0) {\n      return 0;\n    }\n    uint256 c = a * b;\n    assert(c / a == b);\n    return c;\n  }\n\n  /**\n  * @dev Integer division of two numbers, truncating the quotient.\n  */\n  function div(uint256 a, uint256 b) internal pure returns (uint256) {\n    // assert(b > 0); // Solidity automatically throws when dividing by 0\n    uint256 c = a / b;\n    // assert(a == b * c + a % b); // There is no case in which this doesn't hold\n    return c;\n  }\n\n  /**\n  * @dev Substracts two numbers, throws on overflow (i.e. if subtrahend is greater than minuend).\n  */\n  function sub(uint256 a, uint256 b) internal pure returns (uint256) {\n    assert(b <= a);\n    return a - b;\n  }\n\n  /**\n  * @dev Adds two numbers, throws on overflow.\n  */\n  function add(uint256 a, uint256 b) internal pure returns (uint256) {\n    uint256 c = a + b;\n    assert(c >= a);\n    return c;\n  }\n}",
  "bytecode": "6060604052341561000f57600080fd5b60008054600160a060020a03191633600160a060020a0381169190911790915561004790600164010000000061006481026103b21704565b61005f3360016401000000006108916100bf82021704565b610111565b60005433600160a060020a0390811691161461007f57600080fd5b600160a060020a038216151561009457600080fd5b600160a060020a03919091166000908152600160205260409020805460ff1916911515919091179055565b600160a060020a03331660009081526001602052604090205460ff1615156100e657600080fd5b600160a060020a03919091166000908152600260205260409020805460ff1916911515919091179055565b6112d0806101206000396000f3006060604052600436106100cc5763ffffffff60e060020a6000350416630865dadc81146100d15780632210d525146100f75780632693c15014610126578063431dbd9e146101de57806349c9dcf51461022b57806358a4903f1461024d5780636bb7b7a4146102605780636cdb1b75146102735780636fb642de1461029257806376f2ccb9146102b6578063789a12fd146102d55780638da5cb5b1461033e578063b9de1c4114610351578063c2de290914610367578063da7d57f91461037a578063f2fde38b14610393575b600080fd5b34156100dc57600080fd5b6100f5600160a060020a036004351660243515156103b2565b005b341561010257600080fd5b61010a61040d565b604051600160a060020a03909116815260200160405180910390f35b341561013157600080fd5b610145600160a060020a036004351661041d565b604051808060200180602001838103835285818151815260200191508051906020019060200280838360005b83811015610189578082015183820152602001610171565b50505050905001838103825284818151815260200191508051906020019060200280838360005b838110156101c85780820151838201526020016101b0565b5050505090500194505050505060405180910390f35b34156101e957600080fd5b6101f1610543565b6040519485526020850193909352604080850192909252600160a060020a03166060840152608083019190915260a0909101905180910390f35b341561023657600080fd5b6100f5600160a060020a0360043516602435610563565b341561025857600080fd5b61010a610829565b341561026b57600080fd5b61010a610838565b341561027e57600080fd5b6100f5600160a060020a0360043516610847565b341561029d57600080fd5b6100f5600160a060020a03600435166024351515610891565b34156102c157600080fd5b6100f5600160a060020a03600435166108e3565b34156102e057600080fd5b6102eb60043561092d565b60405160208082528190810183818151815260200191508051906020019060200280838360005b8381101561032a578082015183820152602001610312565b505050509050019250505060405180910390f35b341561034957600080fd5b61010a6109a8565b341561035c57600080fd5b6100f56004356109b7565b341561037257600080fd5b6100f5610c3b565b341561038557600080fd5b6100f5600435602435610cf6565b341561039e57600080fd5b6100f5600160a060020a0360043516610e0c565b60005433600160a060020a039081169116146103cd57600080fd5b600160a060020a03821615156103e257600080fd5b600160a060020a03919091166000908152600160205260409020805460ff1916911515919091179055565b600454600160a060020a03165b90565b6104256111ff565b61042d6111ff565b60006104376111ff565b61043f6111ff565b600160a060020a03861660009081526005602052604081206008546002820154919550141561053757836001015460405180591061047a5750595b90808252806020026020018201604052509250836001015460405180591061049f5750595b90808252806020026020018201604052509150600090505b83600101548110156105375783548490829081106104d157fe5b9060005260206000209060020201600001548382815181106104ef57fe5b60209081029091010152835484908290811061050757fe5b90600052602060002090600202016001015482828151811061052557fe5b602090810290910101526001016104b7565b50909590945092505050565b600754600854600954600a54600b54600160a060020a0390911691929394565b6000806000806000806000804260075410151561057f57600080fd5b600a54600160a060020a03161561059557600080fd5b61059d61040d565b600454600854600160a060020a0392831692909116906372eefb8a9060405160e060020a63ffffffff84160281526004810191909152602401602060405180830381600087803b15156105ef57600080fd5b5af115156105fc57600080fd5b50505060405180519050600160a060020a031614151561061b57600080fd5b600a5474010000000000000000000000000000000000000000900460ff16151561064757610647610c3b565b600160a060020a038a16156106e957600160a060020a038a16600090815260056020526040812060018101549099501180156106865750876001015489105b801561069757506008548860020154145b156106e957875488908a9081106106aa57fe5b906000526020600020906002020196508660000154600b54101580156106d657508660010154600b5411155b156106e9576106e48a610ea7565b61081d565b600095505b60085460009081526006602052604090205486101561081d57600854600090815260066020526040902080548790811061072457fe5b6000918252602080832090910154600160a060020a031680835260059091526040822060018101548154929850909650600019019450859190811061076557fe5b906000526020600020906002020160000154600b54101580156107a95750835484908490811061079157fe5b906000526020600020906002020160010154600b5411155b1561081257600091505b83600101548210156108125783548490839081106107cd57fe5b906000526020600020906002020190508060000154600b54101580156107f957508060010154600b5411155b15610807576106e485610ea7565b6001909101906107b3565b6001909501946106ee565b50505050505050505050565b600354600160a060020a031681565b600454600160a060020a031681565b60005433600160a060020a0390811691161461086257600080fd5b6003805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b600160a060020a03331660009081526001602052604090205460ff1615156108b857600080fd5b600160a060020a03919091166000908152600260205260409020805460ff1916911515919091179055565b60005433600160a060020a039081169116146108fe57600080fd5b6004805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b6109356111ff565b6006600083815260200190815260200160002080548060200260200160405190810160405280929190818152602001828054801561099c57602002820191906000526020600020905b8154600160a060020a0316815260019091019060200180831161097e575b50505050509050919050565b600054600160a060020a031681565b60008042600754101515156109cb57600080fd5b600083116109d857600080fd5b6109e4612710846111ba565b6003549092508290600160a060020a03166370a082313360405160e060020a63ffffffff8416028152600160a060020a039091166004820152602401602060405180830381600087803b1515610a3957600080fd5b5af11515610a4657600080fd5b5050506040518051905010151515610a5d57600080fd5b600354600160a060020a031663a1c90a11338460405160e060020a63ffffffff8516028152600160a060020a0390921660048301526024820152604401600060405180830381600087803b1515610ab357600080fd5b5af11515610ac057600080fd5b505050600160a060020a0333166000908152600560205260409020600854600282015491925014610b4e576000600180830182905560085460028401819055825260066020526040909120805490918101610b1b8382611211565b506000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff191633600160a060020a03161790555b805460018201541415610b74578054610b689060016111f0565b610b72828261123a565b505b60408051908101604052600954808252840160001901602082015260018281018054918201905582548391908110610ba857fe5b90600052602060002090600202016000820151815560208201518160010155905050610bd6600954846111f0565b6009556008547fb6d35f558a34938047f09ebf800fa2e15ec407c357a8eab97a5dd67b4d015b5b903390856040518084600160a060020a0316600160a060020a03168152602001838152602001828152602001935050505060405180910390a1505050565b600160a060020a03331660009081526001602052604081205460ff161515610c6257600080fd5b600754429010610c7157600080fd5b600a5474010000000000000000000000000000000000000000900460ff1615610c9957600080fd5b610ca5600954426111f0565b9050600954801515610cb357fe5b8160001943014008600b5550600a805474ff0000000000000000000000000000000000000000191674010000000000000000000000000000000000000000179055565b600160a060020a03331660009081526001602052604090205460ff161515610d1d57600080fd5b60008111610d2a57600080fd5b610d3261040d565b600454600160a060020a0391821691166372eefb8a8360405160e060020a63ffffffff84160281526004810191909152602401602060405180830381600087803b1515610d7e57600080fd5b5af11515610d8b57600080fd5b50505060405180519050600160a060020a0316141515610daa57600080fd5b42829010610db757600080fd5b60085415610dd657600a54600160a060020a03161515610dd657600080fd5b600a80546000600b81905574ffffffffffffffffffffffffffffffffffffffffff19909116909155600955600791909155600855565b60005433600160a060020a03908116911614610e2757600080fd5b600160a060020a0381161515610e3c57600080fd5b600054600160a060020a0380831691167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a36000805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b600a805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a03838116919091179091556004546000918291829182916014911663b4d0e5526040518163ffffffff1660e060020a028152600401602060405180830381600087803b1515610f1757600080fd5b5af11515610f2457600080fd5b50505060405180519050601902811515610f3a57fe5b600454600854929091049550600160a060020a03169063da3678df908760405160e060020a63ffffffff85160281526004810192909252600160a060020a03166024820152604401600060405180830381600087803b1515610f9b57600080fd5b5af11515610fa857600080fd5b5050600454600854600160a060020a0390911691506373a55389908660405160e060020a63ffffffff851602815260048101929092526024820152604401600060405180830381600087803b1515610fff57600080fd5b5af1151561100c57600080fd5b5050600354600160a060020a0316905063e3cbe7448660405160e060020a63ffffffff8416028152600160a060020a039091166004820152602401600060405180830381600087803b151561106057600080fd5b5af1151561106d57600080fd5b5050600454600854600160a060020a03909116915063275babee9060405160e060020a63ffffffff8416028152600481019190915260240160c060405180830381600087803b15156110be57600080fd5b5af115156110cb57600080fd5b505050604051805190602001805190602001805190602001805190602001805190602001805160035493995091975090955050600160a060020a03169250635edc9bff915087905085858560405160e060020a63ffffffff8716028152600160a060020a039094166004850152602484019290925260448301526064820152608401600060405180830381600087803b151561116657600080fd5b5af1151561117357600080fd5b5050507f7b646f14dfb470788710d7469f8c03ffce1aba2693e24050c5055c4cfa9baa5785604051600160a060020a03909116815260200160405180910390a15050505050565b6000808315156111cd57600091506111e9565b508282028284828115156111dd57fe5b04146111e557fe5b8091505b5092915050565b6000828201838110156111e557fe5b60206040519081016040526000815290565b81548183558181151161123557600083815260209020611235918101908301611266565b505050565b815481835581811511611235576002028160020283600052602060002091820191016112359190611284565b61041a91905b80821115611280576000815560010161126c565b5090565b61041a91905b80821115611280576000808255600182015560020161128a5600a165627a7a72305820bb99e956b79b66bf54f84b67871fce6b534acd5df592a1c790a80d703e9886f60029"
}