{
  "address": "0x8d8812b72d1e4ffcec158d25f56748b7d67c1e78",
  "chain": "ETH",
  "chainID": 1,
  "verifier": "etherscan.io",
  "commonName": "",
  "contractName": "LoopringProtocolImpl",
  "compilerVersion": "v0.4.21+commit.dfe3193c",
  "optimization": true,
  "runs": "200",
  "evmVersion": "default",
  "sourceCode": "/**\n *Submitted for verification at Etherscan.io on 2018-05-01\n*/\n\n/*\n  Copyright 2017 Loopring Project Ltd (Loopring Foundation).\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n  http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\npragma solidity 0.4.21;\n/// @title Utility Functions for uint\n/// @author Daniel Wang - <[email protected]>\nlibrary MathUint {\n    function mul(\n        uint a,\n        uint b\n        )\n        internal\n        pure\n        returns (uint c)\n    {\n        c = a * b;\n        require(a == 0 || c / a == b);\n    }\n    function sub(\n        uint a,\n        uint b\n        )\n        internal\n        pure\n        returns (uint)\n    {\n        require(b <= a);\n        return a - b;\n    }\n    function add(\n        uint a,\n        uint b\n        )\n        internal\n        pure\n        returns (uint c)\n    {\n        c = a + b;\n        require(c >= a);\n    }\n    function tolerantSub(\n        uint a,\n        uint b\n        )\n        internal\n        pure\n        returns (uint c)\n    {\n        return (a >= b) ? a - b : 0;\n    }\n    /// @dev calculate the square of Coefficient of Variation (CV)\n    /// https://en.wikipedia.org/wiki/Coefficient_of_variation\n    function cvsquare(\n        uint[] arr,\n        uint scale\n        )\n        internal\n        pure\n        returns (uint)\n    {\n        uint len = arr.length;\n        require(len > 1);\n        require(scale > 0);\n        uint avg = 0;\n        for (uint i = 0; i < len; i++) {\n            avg = add(avg, arr[i]);\n        }\n        avg = avg / len;\n        if (avg == 0) {\n            return 0;\n        }\n        uint cvs = 0;\n        uint s;\n        uint item;\n        for (i = 0; i < len; i++) {\n            item = arr[i];\n            s = item > avg ? item - avg : avg - item;\n            cvs = add(cvs, mul(s, s));\n        }\n        return ((mul(mul(cvs, scale), scale) / avg) / avg) / (len - 1);\n    }\n}\n/*\n  Copyright 2017 Loopring Project Ltd (Loopring Foundation).\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n  http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n/// @title Utility Functions for address\n/// @author Daniel Wang - <[email protected]>\nlibrary AddressUtil {\n    function isContract(\n        address addr\n        )\n        internal\n        view\n        returns (bool)\n    {\n        if (addr == 0x0) {\n            return false;\n        } else {\n            uint size;\n            assembly { size := extcodesize(addr) }\n            return size > 0;\n        }\n    }\n}\n/*\n  Copyright 2017 Loopring Project Ltd (Loopring Foundation).\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n  http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n/*\n  Copyright 2017 Loopring Project Ltd (Loopring Foundation).\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n  http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n/// @title ERC20 Token Interface\n/// @dev see https://github.com/ethereum/EIPs/issues/20\n/// @author Daniel Wang - <[email protected]>\ncontract ERC20 {\n    function balanceOf(\n        address who\n        )\n        view\n        public\n        returns (uint256);\n    function allowance(\n        address owner,\n        address spender\n        )\n        view\n        public\n        returns (uint256);\n    function transfer(\n        address to,\n        uint256 value\n        )\n        public\n        returns (bool);\n    function transferFrom(\n        address from,\n        address to,\n        uint256 value\n        )\n        public\n        returns (bool);\n    function approve(\n        address spender,\n        uint256 value\n        )\n        public\n        returns (bool);\n}\n/*\n  Copyright 2017 Loopring Project Ltd (Loopring Foundation).\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n  http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n/// @title Loopring Token Exchange Protocol Contract Interface\n/// @author Daniel Wang - <[email protected]>\n/// @author Kongliang Zhong - <[email protected]>\ncontract LoopringProtocol {\n    uint8   public constant MARGIN_SPLIT_PERCENTAGE_BASE = 100;\n    /// @dev Event to emit if a ring is successfully mined.\n    /// _amountsList is an array of:\n    /// [_amountS, _amountB, _lrcReward, _lrcFee, splitS, splitB].\n    event RingMined(\n        uint            _ringIndex,\n        bytes32 indexed _ringHash,\n        address         _miner,\n        address         _feeRecipient,\n        bytes32[]       _orderInfoList\n    );\n    event OrderCancelled(\n        bytes32 indexed _orderHash,\n        uint            _amountCancelled\n    );\n    event AllOrdersCancelled(\n        address indexed _address,\n        uint            _cutoff\n    );\n    event OrdersCancelled(\n        address indexed _address,\n        address         _token1,\n        address         _token2,\n        uint            _cutoff\n    );\n    /// @dev Cancel a order. cancel amount(amountS or amountB) can be specified\n    ///      in orderValues.\n    /// @param addresses          owner, tokenS, tokenB, wallet, authAddr\n    /// @param orderValues        amountS, amountB, validSince (second),\n    ///                           validUntil (second), lrcFee, and cancelAmount.\n    /// @param buyNoMoreThanAmountB -\n    ///                           This indicates when a order should be considered\n    ///                           as 'completely filled'.\n    /// @param marginSplitPercentage -\n    ///                           Percentage of margin split to share with miner.\n    /// @param v                  Order ECDSA signature parameter v.\n    /// @param r                  Order ECDSA signature parameters r.\n    /// @param s                  Order ECDSA signature parameters s.\n    function cancelOrder(\n        address[5] addresses,\n        uint[6]    orderValues,\n        bool       buyNoMoreThanAmountB,\n        uint8      marginSplitPercentage,\n        uint8      v,\n        bytes32    r,\n        bytes32    s\n        )\n        external;\n    /// @dev   Set a cutoff timestamp to invalidate all orders whose timestamp\n    ///        is smaller than or equal to the new value of the address's cutoff\n    ///        timestamp, for a specific trading pair.\n    /// @param cutoff The cutoff timestamp, will default to `block.timestamp`\n    ///        if it is 0.\n    function cancelAllOrdersByTradingPair(\n        address token1,\n        address token2,\n        uint cutoff\n        )\n        external;\n    /// @dev   Set a cutoff timestamp to invalidate all orders whose timestamp\n    ///        is smaller than or equal to the new value of the address's cutoff\n    ///        timestamp.\n    /// @param cutoff The cutoff timestamp, will default to `block.timestamp`\n    ///        if it is 0.\n    function cancelAllOrders(\n        uint cutoff\n        )\n        external;\n    /// @dev Submit a order-ring for validation and settlement.\n    /// @param addressList  List of each order's owner, tokenS, wallet, authAddr.\n    ///                     Note that next order's `tokenS` equals this order's\n    ///                     `tokenB`.\n    /// @param uintArgsList List of uint-type arguments in this order:\n    ///                     amountS, amountB, validSince (second),\n    ///                     validUntil (second), lrcFee, and rateAmountS.\n    /// @param uint8ArgsList -\n    ///                     List of unit8-type arguments, in this order:\n    ///                     marginSplitPercentageList.\n    /// @param buyNoMoreThanAmountBList -\n    ///                     This indicates when a order should be considered\n    /// @param vList        List of v for each order. This list is 1-larger than\n    ///                     the previous lists, with the last element being the\n    ///                     v value of the ring signature.\n    /// @param rList        List of r for each order. This list is 1-larger than\n    ///                     the previous lists, with the last element being the\n    ///                     r value of the ring signature.\n    /// @param sList        List of s for each order. This list is 1-larger than\n    ///                     the previous lists, with the last element being the\n    ///                     s value of the ring signature.\n    /// @param feeRecipient Miner address.\n    /// @param feeSelections -\n    ///                     Bits to indicate fee selections. `1` represents margin\n    ///                     split and `0` represents LRC as fee.\n    function submitRing(\n        address[4][]    addressList,\n        uint[6][]       uintArgsList,\n        uint8[1][]      uint8ArgsList,\n        bool[]          buyNoMoreThanAmountBList,\n        uint8[]         vList,\n        bytes32[]       rList,\n        bytes32[]       sList,\n        address         feeRecipient,\n        uint16          feeSelections\n        )\n        public;\n}\n/*\n  Copyright 2017 Loopring Project Ltd (Loopring Foundation).\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n  http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n/// @title Token Register Contract\n/// @dev This contract maintains a list of tokens the Protocol supports.\n/// @author Kongliang Zhong - <[email protected]>,\n/// @author Daniel Wang - <[email protected]>.\ncontract TokenRegistry {\n    event TokenRegistered(\n        address indexed addr,\n        string          symbol\n    );\n    event TokenUnregistered(\n        address indexed addr,\n        string          symbol\n    );\n    function registerToken(\n        address addr,\n        string  symbol\n        )\n        external;\n    function unregisterToken(\n        address addr,\n        string  symbol\n        )\n        external;\n    function areAllTokensRegistered(\n        address[] addressList\n        )\n        external\n        view\n        returns (bool);\n    function getAddressBySymbol(\n        string symbol\n        )\n        external\n        view\n        returns (address);\n    function isTokenRegisteredBySymbol(\n        string symbol\n        )\n        public\n        view\n        returns (bool);\n    function isTokenRegistered(\n        address addr\n        )\n        public\n        view\n        returns (bool);\n    function getTokens(\n        uint start,\n        uint count\n        )\n        public\n        view\n        returns (address[] addressList);\n}\n/*\n  Copyright 2017 Loopring Project Ltd (Loopring Foundation).\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n  http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n/// @title TokenTransferDelegate\n/// @dev Acts as a middle man to transfer ERC20 tokens on behalf of different\n/// versions of Loopring protocol to avoid ERC20 re-authorization.\n/// @author Daniel Wang - <[email protected]>.\ncontract TokenTransferDelegate {\n    event AddressAuthorized(\n        address indexed addr,\n        uint32          number\n    );\n    event AddressDeauthorized(\n        address indexed addr,\n        uint32          number\n    );\n    // The following map is used to keep trace of order fill and cancellation\n    // history.\n    mapping (bytes32 => uint) public cancelledOrFilled;\n    // This map is used to keep trace of order's cancellation history.\n    mapping (bytes32 => uint) public cancelled;\n    // A map from address to its cutoff timestamp.\n    mapping (address => uint) public cutoffs;\n    // A map from address to its trading-pair cutoff timestamp.\n    mapping (address => mapping (bytes20 => uint)) public tradingPairCutoffs;\n    /// @dev Add a Loopring protocol address.\n    /// @param addr A loopring protocol address.\n    function authorizeAddress(\n        address addr\n        )\n        external;\n    /// @dev Remove a Loopring protocol address.\n    /// @param addr A loopring protocol address.\n    function deauthorizeAddress(\n        address addr\n        )\n        external;\n    function getLatestAuthorizedAddresses(\n        uint max\n        )\n        external\n        view\n        returns (address[] addresses);\n    /// @dev Invoke ERC20 transferFrom method.\n    /// @param token Address of token to transfer.\n    /// @param from Address to transfer token from.\n    /// @param to Address to transfer token to.\n    /// @param value Amount of token to transfer.\n    function transferToken(\n        address token,\n        address from,\n        address to,\n        uint    value\n        )\n        external;\n    function batchTransferToken(\n        address lrcTokenAddress,\n        address miner,\n        address minerFeeRecipient,\n        uint8 walletSplitPercentage,\n        bytes32[] batch\n        )\n        external;\n    function isAddressAuthorized(\n        address addr\n        )\n        public\n        view\n        returns (bool);\n    function addCancelled(bytes32 orderHash, uint cancelAmount)\n        external;\n    function addCancelledOrFilled(bytes32 orderHash, uint cancelOrFillAmount)\n        public;\n    function batchAddCancelledOrFilled(bytes32[] batch)\n        public;\n    function setCutoffs(uint t)\n        external;\n    function setTradingPairCutoffs(bytes20 tokenPair, uint t)\n        external;\n    function checkCutoffsBatch(address[] owners, bytes20[] tradingPairs, uint[] validSince)\n        external\n        view;\n    function suspend() external;\n    function resume() external;\n    function kill() external;\n}\n/// @title An Implementation of LoopringProtocol.\n/// @author Daniel Wang - <[email protected]>,\n/// @author Kongliang Zhong - <[email protected]>\n///\n/// Recognized contributing developers from the community:\n///     https://github.com/Brechtpd\n///     https://github.com/rainydio\n///     https://github.com/BenjaminPrice\n///     https://github.com/jonasshen\n///     https://github.com/Hephyrius\ncontract LoopringProtocolImpl is LoopringProtocol {\n    using AddressUtil   for address;\n    using MathUint      for uint;\n    address public constant lrcTokenAddress             = 0xEF68e7C694F40c8202821eDF525dE3782458639f;\n    address public constant tokenRegistryAddress        = 0xAbe12e3548fDb334D11fcc962c413d91Ef12233F;\n    address public constant delegateAddress             = 0x17233e07c67d086464fD408148c3ABB56245FA64;\n    uint64  public  ringIndex                   = 0;\n    uint8   public constant walletSplitPercentage       = 20;\n    // Exchange rate (rate) is the amount to sell or sold divided by the amount\n    // to buy or bought.\n    //\n    // Rate ratio is the ratio between executed rate and an order's original\n    // rate.\n    //\n    // To require all orders' rate ratios to have coefficient ofvariation (CV)\n    // smaller than 2.5%, for an example , rateRatioCVSThreshold should be:\n    //     `(0.025 * RATE_RATIO_SCALE)^2` or 62500.\n    uint    public constant rateRatioCVSThreshold        = 62500;\n    uint    public constant MAX_RING_SIZE       = 16;\n    uint    public constant RATE_RATIO_SCALE    = 10000;\n    /// @param orderHash    The order's hash\n    /// @param feeSelection -\n    ///                     A miner-supplied value indicating if LRC (value = 0)\n    ///                     or margin split is choosen by the miner (value = 1).\n    ///                     We may support more fee model in the future.\n    /// @param rateS        Sell Exchange rate provided by miner.\n    /// @param rateB        Buy Exchange rate provided by miner.\n    /// @param fillAmountS  Amount of tokenS to sell, calculated by protocol.\n    /// @param lrcReward    The amount of LRC paid by miner to order owner in\n    ///                     exchange for margin split.\n    /// @param lrcFeeState  The amount of LR paid by order owner to miner.\n    /// @param splitS      TokenS paid to miner.\n    /// @param splitB      TokenB paid to miner.\n    struct OrderState {\n        address owner;\n        address tokenS;\n        address tokenB;\n        address wallet;\n        address authAddr;\n        uint    validSince;\n        uint    validUntil;\n        uint    amountS;\n        uint    amountB;\n        uint    lrcFee;\n        bool    buyNoMoreThanAmountB;\n        bool    marginSplitAsFee;\n        bytes32 orderHash;\n        uint8   marginSplitPercentage;\n        uint    rateS;\n        uint    rateB;\n        uint    fillAmountS;\n        uint    lrcReward;\n        uint    lrcFeeState;\n        uint    splitS;\n        uint    splitB;\n    }\n    /// @dev A struct to capture parameters passed to submitRing method and\n    ///      various of other variables used across the submitRing core logics.\n    struct RingParams {\n        uint8[]       vList;\n        bytes32[]     rList;\n        bytes32[]     sList;\n        address       feeRecipient;\n        uint16        feeSelections;\n        uint          ringSize;         // computed\n        bytes32       ringHash;         // computed\n    }\n    /// @dev Disable default function.\n    function ()\n        payable\n        public\n    {\n        revert();\n    }\n    function cancelOrder(\n        address[5] addresses,\n        uint[6]    orderValues,\n        bool       buyNoMoreThanAmountB,\n        uint8      marginSplitPercentage,\n        uint8      v,\n        bytes32    r,\n        bytes32    s\n        )\n        external\n    {\n        uint cancelAmount = orderValues[5];\n        require(cancelAmount > 0); // \"amount to cancel is zero\");\n        OrderState memory order = OrderState(\n            addresses[0],\n            addresses[1],\n            addresses[2],\n            addresses[3],\n            addresses[4],\n            orderValues[2],\n            orderValues[3],\n            orderValues[0],\n            orderValues[1],\n            orderValues[4],\n            buyNoMoreThanAmountB,\n            false,\n            0x0,\n            marginSplitPercentage,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0,\n            0\n        );\n        require(msg.sender == order.owner); // \"cancelOrder not submitted by order owner\");\n        bytes32 orderHash = calculateOrderHash(order);\n        verifySignature(\n            order.owner,\n            orderHash,\n            v,\n            r,\n            s\n        );\n        TokenTransferDelegate delegate = TokenTransferDelegate(delegateAddress);\n        delegate.addCancelled(orderHash, cancelAmount);\n        delegate.addCancelledOrFilled(orderHash, cancelAmount);\n        emit OrderCancelled(orderHash, cancelAmount);\n    }\n    function cancelAllOrdersByTradingPair(\n        address token1,\n        address token2,\n        uint    cutoff\n        )\n        external\n    {\n        uint t = (cutoff == 0 || cutoff >= block.timestamp) ? block.timestamp : cutoff;\n        bytes20 tokenPair = bytes20(token1) ^ bytes20(token2);\n        TokenTransferDelegate delegate = TokenTransferDelegate(delegateAddress);\n        require(delegate.tradingPairCutoffs(msg.sender, tokenPair) < t);\n        // \"attempted to set cutoff to a smaller value\"\n        delegate.setTradingPairCutoffs(tokenPair, t);\n        emit OrdersCancelled(\n            msg.sender,\n            token1,\n            token2,\n            t\n        );\n    }\n    function cancelAllOrders(\n        uint cutoff\n        )\n        external\n    {\n        uint t = (cutoff == 0 || cutoff >= block.timestamp) ? block.timestamp : cutoff;\n        TokenTransferDelegate delegate = TokenTransferDelegate(delegateAddress);\n        require(delegate.cutoffs(msg.sender) < t); // \"attempted to set cutoff to a smaller value\"\n        delegate.setCutoffs(t);\n        emit AllOrdersCancelled(msg.sender, t);\n    }\n    function submitRing(\n        address[4][]  addressList,\n        uint[6][]     uintArgsList,\n        uint8[1][]    uint8ArgsList,\n        bool[]        buyNoMoreThanAmountBList,\n        uint8[]       vList,\n        bytes32[]     rList,\n        bytes32[]     sList,\n        address       feeRecipient,\n        uint16        feeSelections\n        )\n        public\n    {\n        // Check if the highest bit of ringIndex is '1'.\n        require((ringIndex >> 63) == 0); // \"attempted to re-ent submitRing function\");\n        // Set the highest bit of ringIndex to '1'.\n        uint64 _ringIndex = ringIndex;\n        ringIndex |= (1 << 63);\n        RingParams memory params = RingParams(\n            vList,\n            rList,\n            sList,\n            feeRecipient,\n            feeSelections,\n            addressList.length,\n            0x0 // ringHash\n        );\n        verifyInputDataIntegrity(\n            params,\n            addressList,\n            uintArgsList,\n            uint8ArgsList,\n            buyNoMoreThanAmountBList\n        );\n        // Assemble input data into structs so we can pass them to other functions.\n        // This method also calculates ringHash, therefore it must be called before\n        // calling `verifyRingSignatures`.\n        TokenTransferDelegate delegate = TokenTransferDelegate(delegateAddress);\n        OrderState[] memory orders = assembleOrders(\n            params,\n            delegate,\n            addressList,\n            uintArgsList,\n            uint8ArgsList,\n            buyNoMoreThanAmountBList\n        );\n        verifyRingSignatures(params, orders);\n        verifyTokensRegistered(params, orders);\n        handleRing(_ringIndex, params, orders, delegate);\n        ringIndex = _ringIndex + 1;\n    }\n    /// @dev Validate a ring.\n    function verifyRingHasNoSubRing(\n        uint          ringSize,\n        OrderState[]  orders\n        )\n        private\n        pure\n    {\n        // Check the ring has no sub-ring.\n        for (uint i = 0; i < ringSize - 1; i++) {\n            address tokenS = orders[i].tokenS;\n            for (uint j = i + 1; j < ringSize; j++) {\n                require(tokenS != orders[j].tokenS); // \"found sub-ring\");\n            }\n        }\n    }\n    /// @dev Verify the ringHash has been signed with each order's auth private\n    ///      keys as well as the miner's private key.\n    function verifyRingSignatures(\n        RingParams params,\n        OrderState[] orders\n        )\n        private\n        pure\n    {\n        uint j;\n        for (uint i = 0; i < params.ringSize; i++) {\n            j = i + params.ringSize;\n            verifySignature(\n                orders[i].authAddr,\n                params.ringHash,\n                params.vList[j],\n                params.rList[j],\n                params.sList[j]\n            );\n        }\n    }\n    function verifyTokensRegistered(\n        RingParams params,\n        OrderState[] orders\n        )\n        private\n        view\n    {\n        // Extract the token addresses\n        address[] memory tokens = new address[](params.ringSize);\n        for (uint i = 0; i < params.ringSize; i++) {\n            tokens[i] = orders[i].tokenS;\n        }\n        // Test all token addresses at once\n        require(\n            TokenRegistry(tokenRegistryAddress).areAllTokensRegistered(tokens)\n        ); // \"token not registered\");\n    }\n    function handleRing(\n        uint64       _ringIndex,\n        RingParams   params,\n        OrderState[] orders,\n        TokenTransferDelegate delegate\n        )\n        private\n    {\n        address _lrcTokenAddress = lrcTokenAddress;\n        // Do the hard work.\n        verifyRingHasNoSubRing(params.ringSize, orders);\n        // Exchange rates calculation are performed by ring-miners as solidity\n        // cannot get power-of-1/n operation, therefore we have to verify\n        // these rates are correct.\n        verifyMinerSuppliedFillRates(params.ringSize, orders);\n        // Scale down each order independently by substracting amount-filled and\n        // amount-cancelled. Order owner's current balance and allowance are\n        // not taken into consideration in these operations.\n        scaleRingBasedOnHistoricalRecords(delegate, params.ringSize, orders);\n        // Based on the already verified exchange rate provided by ring-miners,\n        // we can furthur scale down orders based on token balance and allowance,\n        // then find the smallest order of the ring, then calculate each order's\n        // `fillAmountS`.\n        calculateRingFillAmount(params.ringSize, orders);\n        // Calculate each order's `lrcFee` and `lrcRewrard` and splict how much\n        // of `fillAmountS` shall be paid to matching order or miner as margin\n        // split.\n        calculateRingFees(\n            delegate,\n            params.ringSize,\n            orders,\n            _lrcTokenAddress\n        );\n        /// Make transfers.\n        bytes32[] memory orderInfoList = settleRing(\n            delegate,\n            params.ringSize,\n            orders,\n            params.feeRecipient,\n            _lrcTokenAddress\n        );\n        emit RingMined(\n            _ringIndex,\n            params.ringHash,\n            tx.origin,\n            params.feeRecipient,\n            orderInfoList\n        );\n    }\n    function settleRing(\n        TokenTransferDelegate delegate,\n        uint          ringSize,\n        OrderState[]  orders,\n        address       feeRecipient,\n        address       _lrcTokenAddress\n        )\n        private\n        returns (bytes32[] memory orderInfoList)\n    {\n        bytes32[] memory batch = new bytes32[](ringSize * 7); // ringSize * (owner + tokenS + 4 amounts + wallet)\n        bytes32[] memory historyBatch = new bytes32[](ringSize * 2); // ringSize * (orderhash, fillAmount)\n        orderInfoList = new bytes32[](ringSize * 7);\n        uint p = 0;\n        uint q = 0;\n        uint r = 0;\n        uint prevSplitB = orders[ringSize - 1].splitB;\n        for (uint i = 0; i < ringSize; i++) {\n            OrderState memory state = orders[i];\n            uint nextFillAmountS = orders[(i + 1) % ringSize].fillAmountS;\n            // Store owner and tokenS of every order\n            batch[p++] = bytes32(state.owner);\n            batch[p++] = bytes32(state.tokenS);\n            // Store all amounts\n            batch[p++] = bytes32(state.fillAmountS.sub(prevSplitB));\n            batch[p++] = bytes32(prevSplitB.add(state.splitS));\n            batch[p++] = bytes32(state.lrcReward);\n            batch[p++] = bytes32(state.lrcFeeState);\n            batch[p++] = bytes32(state.wallet);\n            historyBatch[r++] = state.orderHash;\n            historyBatch[r++] = bytes32(\n                state.buyNoMoreThanAmountB ? nextFillAmountS : state.fillAmountS);\n            orderInfoList[q++] = bytes32(state.orderHash);\n            orderInfoList[q++] = bytes32(state.owner);\n            orderInfoList[q++] = bytes32(state.tokenS);\n            orderInfoList[q++] = bytes32(state.fillAmountS);\n            orderInfoList[q++] = bytes32(state.lrcReward);\n            orderInfoList[q++] = bytes32(\n                state.lrcFeeState > 0 ? int(state.lrcFeeState) : -int(state.lrcReward)\n            );\n            orderInfoList[q++] = bytes32(\n                state.splitS > 0 ? int(state.splitS) : -int(state.splitB)\n            );\n            prevSplitB = state.splitB;\n        }\n        // Update fill records\n        delegate.batchAddCancelledOrFilled(historyBatch);\n        // Do all transactions\n        delegate.batchTransferToken(\n            _lrcTokenAddress,\n            tx.origin,\n            feeRecipient,\n            walletSplitPercentage,\n            batch\n        );\n    }\n    /// @dev Verify miner has calculte the rates correctly.\n    function verifyMinerSuppliedFillRates(\n        uint         ringSize,\n        OrderState[] orders\n        )\n        private\n        pure\n    {\n        uint[] memory rateRatios = new uint[](ringSize);\n        uint _rateRatioScale = RATE_RATIO_SCALE;\n        for (uint i = 0; i < ringSize; i++) {\n            uint s1b0 = orders[i].rateS.mul(orders[i].amountB);\n            uint s0b1 = orders[i].amountS.mul(orders[i].rateB);\n            require(s1b0 <= s0b1); // \"miner supplied exchange rate provides invalid discount\");\n            rateRatios[i] = _rateRatioScale.mul(s1b0) / s0b1;\n        }\n        uint cvs = MathUint.cvsquare(rateRatios, _rateRatioScale);\n        require(cvs <= rateRatioCVSThreshold);\n        // \"miner supplied exchange rate is not evenly discounted\");\n    }\n    /// @dev Calculate each order's fee or LRC reward.\n    function calculateRingFees(\n        TokenTransferDelegate delegate,\n        uint            ringSize,\n        OrderState[]    orders,\n        address         _lrcTokenAddress\n        )\n        private\n        view\n    {\n        bool checkedMinerLrcSpendable = false;\n        uint minerLrcSpendable = 0;\n        uint8 _marginSplitPercentageBase = MARGIN_SPLIT_PERCENTAGE_BASE;\n        uint nextFillAmountS;\n        for (uint i = 0; i < ringSize; i++) {\n            OrderState memory state = orders[i];\n            uint lrcReceiable = 0;\n            if (state.lrcFeeState == 0) {\n                // When an order's LRC fee is 0 or smaller than the specified fee,\n                // we help miner automatically select margin-split.\n                state.marginSplitAsFee = true;\n                state.marginSplitPercentage = _marginSplitPercentageBase;\n            } else {\n                uint lrcSpendable = getSpendable(\n                    delegate,\n                    _lrcTokenAddress,\n                    state.owner\n                );\n                // If the order is selling LRC, we need to calculate how much LRC\n                // is left that can be used as fee.\n                if (state.tokenS == _lrcTokenAddress) {\n                    lrcSpendable = lrcSpendable.sub(state.fillAmountS);\n                }\n                // If the order is buyign LRC, it will has more to pay as fee.\n                if (state.tokenB == _lrcTokenAddress) {\n                    nextFillAmountS = orders[(i + 1) % ringSize].fillAmountS;\n                    lrcReceiable = nextFillAmountS;\n                }\n                uint lrcTotal = lrcSpendable.add(lrcReceiable);\n                // If order doesn't have enough LRC, set margin split to 100%.\n                if (lrcTotal < state.lrcFeeState) {\n                    state.lrcFeeState = lrcTotal;\n                    state.marginSplitPercentage = _marginSplitPercentageBase;\n                }\n                if (state.lrcFeeState == 0) {\n                    state.marginSplitAsFee = true;\n                }\n            }\n            if (!state.marginSplitAsFee) {\n                if (lrcReceiable > 0) {\n                    if (lrcReceiable >= state.lrcFeeState) {\n                        state.splitB = state.lrcFeeState;\n                        state.lrcFeeState = 0;\n                    } else {\n                        state.splitB = lrcReceiable;\n                        state.lrcFeeState = state.lrcFeeState.sub(lrcReceiable);\n                    }\n                }\n            } else {\n                // Only check the available miner balance when absolutely needed\n                if (!checkedMinerLrcSpendable && minerLrcSpendable < state.lrcFeeState) {\n                    checkedMinerLrcSpendable = true;\n                    minerLrcSpendable = getSpendable(delegate, _lrcTokenAddress, tx.origin);\n                }\n                // Only calculate split when miner has enough LRC;\n                // otherwise all splits are 0.\n                if (minerLrcSpendable >= state.lrcFeeState) {\n                    nextFillAmountS = orders[(i + 1) % ringSize].fillAmountS;\n                    uint split;\n                    if (state.buyNoMoreThanAmountB) {\n                        split = (nextFillAmountS.mul(\n                            state.amountS\n                        ) / state.amountB).sub(\n                            state.fillAmountS\n                        );\n                    } else {\n                        split = nextFillAmountS.sub(\n                            state.fillAmountS.mul(\n                                state.amountB\n                            ) / state.amountS\n                        );\n                    }\n                    if (state.marginSplitPercentage != _marginSplitPercentageBase) {\n                        split = split.mul(\n                            state.marginSplitPercentage\n                        ) / _marginSplitPercentageBase;\n                    }\n                    if (state.buyNoMoreThanAmountB) {\n                        state.splitS = split;\n                    } else {\n                        state.splitB = split;\n                    }\n                    // This implicits order with smaller index in the ring will\n                    // be paid LRC reward first, so the orders in the ring does\n                    // mater.\n                    if (split > 0) {\n                        minerLrcSpendable = minerLrcSpendable.sub(state.lrcFeeState);\n                        state.lrcReward = state.lrcFeeState;\n                    }\n                }\n                state.lrcFeeState = 0;\n            }\n        }\n    }\n    /// @dev Calculate each order's fill amount.\n    function calculateRingFillAmount(\n        uint          ringSize,\n        OrderState[]  orders\n        )\n        private\n        pure\n    {\n        uint smallestIdx = 0;\n        uint i;\n        uint j;\n        for (i = 0; i < ringSize; i++) {\n            j = (i + 1) % ringSize;\n            smallestIdx = calculateOrderFillAmount(\n                orders[i],\n                orders[j],\n                i,\n                j,\n                smallestIdx\n            );\n        }\n        for (i = 0; i < smallestIdx; i++) {\n            calculateOrderFillAmount(\n                orders[i],\n                orders[(i + 1) % ringSize],\n                0,               // Not needed\n                0,               // Not needed\n                0                // Not needed\n            );\n        }\n    }\n    /// @return The smallest order's index.\n    function calculateOrderFillAmount(\n        OrderState state,\n        OrderState next,\n        uint       i,\n        uint       j,\n        uint       smallestIdx\n        )\n        private\n        pure\n        returns (uint newSmallestIdx)\n    {\n        // Default to the same smallest index\n        newSmallestIdx = smallestIdx;\n        uint fillAmountB = state.fillAmountS.mul(\n            state.rateB\n        ) / state.rateS;\n        if (state.buyNoMoreThanAmountB) {\n            if (fillAmountB > state.amountB) {\n                fillAmountB = state.amountB;\n                state.fillAmountS = fillAmountB.mul(\n                    state.rateS\n                ) / state.rateB;\n                require(state.fillAmountS > 0);\n                newSmallestIdx = i;\n            }\n            state.lrcFeeState = state.lrcFee.mul(\n                fillAmountB\n            ) / state.amountB;\n        } else {\n            state.lrcFeeState = state.lrcFee.mul(\n                state.fillAmountS\n            ) / state.amountS;\n        }\n        if (fillAmountB <= next.fillAmountS) {\n            next.fillAmountS = fillAmountB;\n        } else {\n            newSmallestIdx = j;\n        }\n    }\n    /// @dev Scale down all orders based on historical fill or cancellation\n    ///      stats but key the order's original exchange rate.\n    function scaleRingBasedOnHistoricalRecords(\n        TokenTransferDelegate delegate,\n        uint ringSize,\n        OrderState[] orders\n        )\n        private\n        view\n    {\n        for (uint i = 0; i < ringSize; i++) {\n            OrderState memory state = orders[i];\n            uint amount;\n            if (state.buyNoMoreThanAmountB) {\n                amount = state.amountB.tolerantSub(\n                    delegate.cancelledOrFilled(state.orderHash)\n                );\n                state.amountS = amount.mul(state.amountS) / state.amountB;\n                state.lrcFee = amount.mul(state.lrcFee) / state.amountB;\n                state.amountB = amount;\n            } else {\n                amount = state.amountS.tolerantSub(\n                    delegate.cancelledOrFilled(state.orderHash)\n                );\n                state.amountB = amount.mul(state.amountB) / state.amountS;\n                state.lrcFee = amount.mul(state.lrcFee) / state.amountS;\n                state.amountS = amount;\n            }\n            require(state.amountS > 0); // \"amountS is zero\");\n            require(state.amountB > 0); // \"amountB is zero\");\n            uint availableAmountS = getSpendable(delegate, state.tokenS, state.owner);\n            require(availableAmountS > 0); // \"order spendable amountS is zero\");\n            state.fillAmountS = (\n                state.amountS < availableAmountS ?\n                state.amountS : availableAmountS\n            );\n            require(state.fillAmountS > 0);\n        }\n    }\n    /// @return Amount of ERC20 token that can be spent by this contract.\n    function getSpendable(\n        TokenTransferDelegate delegate,\n        address tokenAddress,\n        address tokenOwner\n        )\n        private\n        view\n        returns (uint)\n    {\n        ERC20 token = ERC20(tokenAddress);\n        uint allowance = token.allowance(\n            tokenOwner,\n            address(delegate)\n        );\n        uint balance = token.balanceOf(tokenOwner);\n        return (allowance < balance ? allowance : balance);\n    }\n    /// @dev verify input data's basic integrity.\n    function verifyInputDataIntegrity(\n        RingParams params,\n        address[4][]  addressList,\n        uint[6][]     uintArgsList,\n        uint8[1][]    uint8ArgsList,\n        bool[]        buyNoMoreThanAmountBList\n        )\n        private\n        pure\n    {\n        require(params.feeRecipient != 0x0);\n        require(params.ringSize == addressList.length);\n        require(params.ringSize == uintArgsList.length);\n        require(params.ringSize == uint8ArgsList.length);\n        require(params.ringSize == buyNoMoreThanAmountBList.length);\n        // Validate ring-mining related arguments.\n        for (uint i = 0; i < params.ringSize; i++) {\n            require(uintArgsList[i][5] > 0); // \"order rateAmountS is zero\");\n        }\n        //Check ring size\n        require(params.ringSize > 1 && params.ringSize <= MAX_RING_SIZE); // \"invalid ring size\");\n        uint sigSize = params.ringSize << 1;\n        require(sigSize == params.vList.length);\n        require(sigSize == params.rList.length);\n        require(sigSize == params.sList.length);\n    }\n    /// @dev        assmble order parameters into Order struct.\n    /// @return     A list of orders.\n    function assembleOrders(\n        RingParams params,\n        TokenTransferDelegate delegate,\n        address[4][]  addressList,\n        uint[6][]     uintArgsList,\n        uint8[1][]    uint8ArgsList,\n        bool[]        buyNoMoreThanAmountBList\n        )\n        private\n        view\n        returns (OrderState[] memory orders)\n    {\n        orders = new OrderState[](params.ringSize);\n        for (uint i = 0; i < params.ringSize; i++) {\n            uint[6] memory uintArgs = uintArgsList[i];\n            bool marginSplitAsFee = (params.feeSelections & (uint16(1) << i)) > 0;\n            orders[i] = OrderState(\n                addressList[i][0],\n                addressList[i][1],\n                addressList[(i + 1) % params.ringSize][1],\n                addressList[i][2],\n                addressList[i][3],\n                uintArgs[2],\n                uintArgs[3],\n                uintArgs[0],\n                uintArgs[1],\n                uintArgs[4],\n                buyNoMoreThanAmountBList[i],\n                marginSplitAsFee,\n                bytes32(0),\n                uint8ArgsList[i][0],\n                uintArgs[5],\n                uintArgs[1],\n                0,   // fillAmountS\n                0,   // lrcReward\n                0,   // lrcFee\n                0,   // splitS\n                0    // splitB\n            );\n            validateOrder(orders[i]);\n            bytes32 orderHash = calculateOrderHash(orders[i]);\n            orders[i].orderHash = orderHash;\n            verifySignature(\n                orders[i].owner,\n                orderHash,\n                params.vList[i],\n                params.rList[i],\n                params.sList[i]\n            );\n            params.ringHash ^= orderHash;\n        }\n        validateOrdersCutoffs(orders, delegate);\n        params.ringHash = keccak256(\n            params.ringHash,\n            params.feeRecipient,\n            params.feeSelections\n        );\n    }\n    /// @dev validate order's parameters are OK.\n    function validateOrder(\n        OrderState order\n        )\n        private\n        view\n    {\n        require(order.owner != 0x0); // invalid order owner\n        require(order.tokenS != 0x0); // invalid order tokenS\n        require(order.tokenB != 0x0); // invalid order tokenB\n        require(order.amountS != 0); // invalid order amountS\n        require(order.amountB != 0); // invalid order amountB\n        require(order.marginSplitPercentage <= MARGIN_SPLIT_PERCENTAGE_BASE);\n        // invalid order marginSplitPercentage\n        require(order.validSince <= block.timestamp); // order is too early to match\n        require(order.validUntil > block.timestamp); // order is expired\n    }\n    function validateOrdersCutoffs(OrderState[] orders, TokenTransferDelegate delegate)\n        private\n        view\n    {\n        address[] memory owners = new address[](orders.length);\n        bytes20[] memory tradingPairs = new bytes20[](orders.length);\n        uint[] memory validSinceTimes = new uint[](orders.length);\n        for (uint i = 0; i < orders.length; i++) {\n            owners[i] = orders[i].owner;\n            tradingPairs[i] = bytes20(orders[i].tokenS) ^ bytes20(orders[i].tokenB);\n            validSinceTimes[i] = orders[i].validSince;\n        }\n        delegate.checkCutoffsBatch(owners, tradingPairs, validSinceTimes);\n    }\n    /// @dev Get the Keccak-256 hash of order with specified parameters.\n    function calculateOrderHash(\n        OrderState order\n        )\n        private\n        pure\n        returns (bytes32)\n    {\n        return keccak256(\n            delegateAddress,\n            order.owner,\n            order.tokenS,\n            order.tokenB,\n            order.wallet,\n            order.authAddr,\n            order.amountS,\n            order.amountB,\n            order.validSince,\n            order.validUntil,\n            order.lrcFee,\n            order.buyNoMoreThanAmountB,\n            order.marginSplitPercentage\n        );\n    }\n    /// @dev Verify signer's signature.\n    function verifySignature(\n        address signer,\n        bytes32 hash,\n        uint8   v,\n        bytes32 r,\n        bytes32 s\n        )\n        private\n        pure\n    {\n        require(\n            signer == ecrecover(\n                keccak256(\"\\x19Ethereum Signed Message:\\n32\", hash),\n                v,\n                r,\n                s\n            )\n        ); // \"invalid signature\");\n    }\n    function getTradingPairCutoffs(\n        address orderOwner,\n        address token1,\n        address token2\n        )\n        public\n        view\n        returns (uint)\n    {\n        bytes20 tokenPair = bytes20(token1) ^ bytes20(token2);\n        TokenTransferDelegate delegate = TokenTransferDelegate(delegateAddress);\n        return delegate.tradingPairCutoffs(orderOwner, tokenPair);\n    }\n}",
  "bytecode": "60606040526000805467ffffffffffffffff19169055341561002057600080fd5b612ba68061002f6000396000f3006060604052600436106100b65763ffffffff60e060020a6000350416632db237bb81146100bb57806341ffbc1f146100e45780634a63864b146101145780634c0a6532146101395780635be2aca0146101685780636d96a2aa1461017b57806370c55e1f1461018e5780638865cbd6146101b95780638c59f7ca146101e3578063a37641ff14610216578063bd545f5314610229578063df565ca21461023f578063e78aadb214610252578063f829d1a0146104c8575b600080fd5b34156100c657600080fd5b6100ce6104db565b60405160ff909116815260200160405180910390f35b34156100ef57600080fd5b6100f76104e0565b60405167ffffffffffffffff909116815260200160405180910390f35b341561011f57600080fd5b6101276104f0565b60405190815260200160405180910390f35b341561014457600080fd5b61014c6104f6565b604051600160a060020a03909116815260200160405180910390f35b341561017357600080fd5b61014c61050e565b341561018657600080fd5b61014c610526565b341561019957600080fd5b610127600160a060020a036004358116906024358116906044351661053e565b34156101c457600080fd5b6101e1600160a060020a03600435811690602435166044356105e4565b005b34156101ee57600080fd5b6101e1600460a461016435151560ff610184358116906101a435166101c4356101e435610779565b341561022157600080fd5b6101276109ba565b341561023457600080fd5b6101e16004356109bf565b341561024a57600080fd5b610127610af5565b341561025d57600080fd5b6101e160046024813581810190830135806020818102016040519081016040528181529291906000602085015b828210156102c657608080830286019060049060405190810160405291908282608080828437505050918352505060019091019060200161028a565b505050505091908035906020019082018035906020019080806020026020016040519081016040528181529291906000602085015b828210156103375760c08083028601906006906040519081016040529190828260c08082843750505091835250506001909101906020016102fb565b505050505091908035906020019082018035906020019080806020026020016040519081016040528181529291906000602085015b828210156103a857602080830286019060019060405190810160405291908282602080828437505050918352505060019091019060200161036c565b5050505050919080359060200190820180359060200190808060200260200160405190810160405280939291908181526020018383602002808284378201915050505050509190803590602001908201803590602001908080602002602001604051908101604052809392919081815260200183836020028082843782019150505050505091908035906020019082018035906020019080806020026020016040519081016040528093929190818152602001838360200280828437820191505050505050919080359060200190820180359060200190808060200260200160405190810160405280939291908181526020018383602002808284375094965050508335600160a060020a0316936020013561ffff169250610afb915050565b34156104d357600080fd5b6100ce610c30565b606481565b60005467ffffffffffffffff1681565b61271081565b73ef68e7c694f40c8202821edf525de3782458639f81565b73abe12e3548fdb334d11fcc962c413d91ef12233f81565b7317233e07c67d086464fd408148c3abb56245fa6481565b60006c01000000000000000000000000838102908302187317233e07c67d086464fd408148c3abb56245fa648063b8d641a3878460405160e060020a63ffffffff8516028152600160a060020a0390921660048301526bffffffffffffffffffffffff19166024820152604401602060405180830381600087803b15156105c457600080fd5b5af115156105d157600080fd5b5050506040518051979650505050505050565b600080808315806105f55750428410155b6105ff5783610601565b425b925050506c01000000000000000000000000848102908402187317233e07c67d086464fd408148c3abb56245fa64828163b8d641a3338560405160e060020a63ffffffff8516028152600160a060020a0390921660048301526bffffffffffffffffffffffff19166024820152604401602060405180830381600087803b151561068a57600080fd5b5af1151561069757600080fd5b505050604051805190501015156106ad57600080fd5b80600160a060020a0316634b99f0c5838560405160e060020a63ffffffff85160281526bffffffffffffffffffffffff1990921660048301526024820152604401600060405180830381600087803b151561070757600080fd5b5af1151561071457600080fd5b50505033600160a060020a03167fa28167ee3483d28d6ed569bccaba7f8525dae3ee816b82eca0b809b830e8df87878786604051600160a060020a039384168152919092166020820152604080820192909252606001905180910390a2505050505050565b6000610783612a19565b60a0880135915060008080841161079957600080fd5b6102a06040519081016040908152600160a060020a038d35811683526020808f01358216908401528d8201358116918301919091526060808e01358216908301526080808e01359091169082015260a081018b60026020908102919091013582526060808e0135838301528d356040840152908d0135908201526080808d0135908201528a151560a0820152600060c0820181905260e0820181905260ff8b1661010083015261012082018190526101408201819052610160820181905261018082018190526101a082018190526101c082018190526101e09091015292508251600160a060020a031633600160a060020a031614151561089957600080fd5b6108a283610c35565b91506108b2835183898989610d4f565b507317233e07c67d086464fd408148c3abb56245fa648063c955b514838660405160e060020a63ffffffff851602815260048101929092526024820152604401600060405180830381600087803b151561090b57600080fd5b5af1151561091857600080fd5b50505080600160a060020a03166326fed988838660405160e060020a63ffffffff851602815260048101929092526024820152604401600060405180830381600087803b151561096757600080fd5b5af1151561097457600080fd5b508391507f3e1003227205ab9eb9b1652e25b2f6fc548ff55e94bf76a42aca90501c6c4e3590508560405190815260200160405180910390a25050505050505050505050565b601081565b6000808215806109cf5750428310155b6109d957826109db565b425b91507317233e07c67d086464fd408148c3abb56245fa649050818163de794c1e3360405160e060020a63ffffffff8416028152600160a060020a039091166004820152602401602060405180830381600087803b1515610a3a57600080fd5b5af11515610a4757600080fd5b50505060405180519050101515610a5d57600080fd5b80600160a060020a031663fd902d1e8360405160e060020a63ffffffff84160281526004810191909152602401600060405180830381600087803b1515610aa357600080fd5b5af11515610ab057600080fd5b50505033600160a060020a03167f83a782ac7424737a1190d4668474e765f07d603de0485a081dbc343ac1b020998360405190815260200160405180910390a2505050565b61f42481565b6000610b05612af1565b6000610b0f612b41565b60005467800000000000000067ffffffffffffffff918216041615610b3357600080fd5b6000805467ffffffffffffffff19811667ffffffffffffffff918216678000000000000000811790921617909155935060e0604051908101604052808a815260200189815260200188815260200187600160a060020a031681526020018661ffff1681526020018e51815260006020909101529250610bb5838e8e8e8e610e07565b7317233e07c67d086464fd408148c3abb56245fa649150610bda83838f8f8f8f610f17565b9050610be683826112cb565b610bf08382611355565b610bfc8484838561148d565b50506000805467ffffffffffffffff191660019390930167ffffffffffffffff169290921790915550505050505050505050565b601481565b60007317233e07c67d086464fd408148c3abb56245fa64825183602001518460400151856060015186608001518760e001518861010001518960a001518a60c001518b61012001518c61014001518d6101a001516040516c01000000000000000000000000600160a060020a039e8f16810282529c8e168d0260148201529a8d168c0260288c0152988c168b02603c8b0152968b168a0260508a01529490991690970260648701526078860191909152609885015260b884019490945260d883019490945260f88201929092527f0100000000000000000000000000000000000000000000000000000000000000921515830261011882015260ff90911690910261011982015261011a0160405180910390209050919050565b6001846040517f19457468657265756d205369676e6564204d6573736167653a0a3332000000008152601c810191909152603c0160405180910390208484846040516000815260200160405260405193845260ff9092166020808501919091526040808501929092526060840192909252608090920191516020810390808403906000865af11515610de057600080fd5b505060206040510351600160a060020a03868116911614610e0057600080fd5b5050505050565b6000808660600151600160a060020a03161515610e2357600080fd5b85518760a0015114610e3457600080fd5b84518760a0015114610e4557600080fd5b83518760a0015114610e5657600080fd5b82518760a0015114610e6757600080fd5b600091505b8660a00151821015610ea9576000858381518110610e8657fe5b9060200190602002015160a0015111610e9e57600080fd5b600190910190610e6c565b60018760a00151118015610ec2575060108760a0015111155b1515610ecd57600080fd5b60018760a001519060020a0290508660000151518114610eec57600080fd5b8660200151518114610efd57600080fd5b8660400151518114610f0e57600080fd5b50505050505050565b610f1f612b41565b6000610f29612b53565b6000808a60a00151604051805910610f3e5750595b908082528060200260200182016040528015610f7457816020015b610f61612a19565b815260200190600190039081610f595790505b509450600093505b8a60a0015184101561123f57878481518110610f9457fe5b9060200190602002015192506000600285900a60808d01511661ffff161191506102a0604051908101604052808a8681518110610fcd57fe5b9060200190602002015151600160a060020a031681526020018a8681518110610ff257fe5b9060200190602002015160200151600160a060020a031681526020018a8d60a001518760010181151561102157fe5b068151811061102c57fe5b9060200190602002015160200151600160a060020a031681526020018a868151811061105457fe5b9060200190602002015160400151600160a060020a031681526020018a868151811061107c57fe5b9060200190602002015160600151600160a060020a0316815260200160408501518152602001606085015181526020018451815260200184600160200201518152602001608085015181526020018786815181106110d657fe5b906020019060200201511515815283151560208201526000604082015260600188868151811061110257fe5b906020019060200201515160ff16815260200160a085015181526020018460016020020151815260200160008152602001600081526020016000815260200160008152602001600081525085858151811061115957fe5b6020908102909101015261118185858151811061117257fe5b906020019060200201516115c0565b61119f85858151811061119057fe5b90602001906020020151610c35565b9050808585815181106111ae57fe5b9060200190602002015161018001526112288585815181106111cc57fe5b9060200190602002015151828d5187815181106111e557fe5b906020019060200201518e6020015188815181106111ff57fe5b906020019060200201518f60400151898151811061121957fe5b90602001906020020151610d4f565b808b60c00181815118905250600190930192610f7c565b611249858b611663565b8a60c001518b606001518c60800151604051928352600160a060020a03919091166c0100000000000000000000000002602083015261ffff167e0100000000000000000000000000000000000000000000000000000000000002603482015260360160405190819003902060c0909b019a909a52509198975050505050505050565b6000805b8360a0015181101561134f578360a00151810191506113478382815181106112f357fe5b90602001906020020151608001518560c001518651858151811061131357fe5b906020019060200201518760200151868151811061132d57fe5b906020019060200201518860400151878151811061121957fe5b6001016112cf565b50505050565b61135d612b41565b60008360a001516040518059106113715750595b90808252806020026020018201604052509150600090505b8360a001518110156113da578281815181106113a157fe5b90602001906020020151602001518282815181106113bb57fe5b600160a060020a03909216602092830290910190910152600101611389565b73abe12e3548fdb334d11fcc962c413d91ef12233f6316066e69836040518263ffffffff1660e060020a0281526004018080602001828103825283818151815260200191508051906020019060200280838360005b8381101561144757808201518382015260200161142f565b5050505090500192505050602060405180830381600087803b151561146b57600080fd5b5af1151561147857600080fd5b50505060405180519050151561134f57600080fd5b6000611497612b41565b73ef68e7c694f40c8202821edf525de3782458639f91506114bc8560a0015185611908565b6114ca8560a0015185611987565b6114d9838660a0015186611ac5565b6114e78560a0015185611d2e565b6114f7838660a001518685611df0565b61150c838660a0015186886060015186612134565b90508460c001517f4d2a4adf7c5f6cf35d97aecc1919897bf86299dccd9b5e19b2b38ebebf07add0873260608901518560405167ffffffffffffffff85168152600160a060020a0380851660208301528316604082015260806060820181815290820183818151815260200191508051906020019060200280838360005b838110156115a257808201518382015260200161158a565b505050509050019550505050505060405180910390a2505050505050565b8051600160a060020a031615156115d657600080fd5b8060200151600160a060020a031615156115ef57600080fd5b8060400151600160a060020a0316151561160857600080fd5b8060e00151151561161857600080fd5b806101000151151561162957600080fd5b60646101a082015160ff16111561163f57600080fd5b428160a00151111561165057600080fd5b428160c001511161166057600080fd5b50565b61166b612b41565b611673612b41565b61167b612b41565b6000855160405180591061168c5750595b9080825280602002602001820160405250935085516040518059106116ae5750595b9080825280602002602001820160405250925085516040518059106116d05750595b90808252806020026020018201604052509150600090505b85518110156117df578581815181106116fd57fe5b906020019060200201515184828151811061171457fe5b600160a060020a0390921660209283029091019091015285818151811061173757fe5b90602001906020020151604001516c010000000000000000000000000286828151811061176057fe5b90602001906020020151602001516c01000000000000000000000000021883828151811061178a57fe5b6bffffffffffffffffffffffff199092166020928302909101909101528581815181106117b357fe5b9060200190602002015160a001518282815181106117cd57fe5b602090810290910101526001016116e8565b84600160a060020a031662a16cab8585856040518463ffffffff1660e060020a02815260040180806020018060200180602001848103845287818151815260200191508051906020019060200280838360005b8381101561184a578082015183820152602001611832565b50505050905001848103835286818151815260200191508051906020019060200280838360005b83811015611889578082015183820152602001611871565b50505050905001848103825285818151815260200191508051906020019060200280838360005b838110156118c85780820151838201526020016118b0565b505050509050019650505050505050600060405180830381600087803b15156118f057600080fd5b5af115156118fd57600080fd5b505050505050505050565b600080805b60018503831015610e005783838151811061192457fe5b9060200190602002015160200151915050600182015b8481101561197c5783818151811061194e57fe5b9060200190602002015160200151600160a060020a038381169116141561197457600080fd5b60010161193a565b60019092019161190d565b61198f612b41565b6000806000806000876040518059106119a55750595b908082528060200260200182016040525095506127109450600093505b87841015611aa057611a0f8785815181106119d957fe5b9060200190602002015161010001518886815181106119f457fe5b906020019060200201516101c001519063ffffffff61267f16565b9250611a55878581518110611a2057fe5b906020019060200201516101e00151888681518110611a3b57fe5b9060200190602002015160e001519063ffffffff61267f16565b915081831115611a6457600080fd5b81611a75868563ffffffff61267f16565b811515611a7e57fe5b04868581518110611a8b57fe5b602090810290910101526001909301926119c2565b611aaa86866126aa565b905061f424811115611abb57600080fd5b5050505050505050565b6000611acf612a19565b600080600093505b85841015610f0e57848481518110611aeb57fe5b90602001906020020151925082610140015115611bde57611b7987600160a060020a0316635511f31985610180015160405160e060020a63ffffffff84160281526004810191909152602401602060405180830381600087803b1515611b5057600080fd5b5af11515611b5d57600080fd5b505050604051805190508461010001519063ffffffff6127d216565b9150826101000151611b968460e00151849063ffffffff61267f16565b811515611b9f57fe5b0460e0840152610100830151611bc1846101200151849063ffffffff61267f16565b811515611bca57fe5b046101208401526101008301829052611cb4565b611c5487600160a060020a0316635511f31985610180015160405160e060020a63ffffffff84160281526004810191909152602401602060405180830381600087803b1515611c2c57600080fd5b5af11515611c3957600080fd5b505050604051805190508460e001519063ffffffff6127d216565b91508260e00151611c71846101000151849063ffffffff61267f16565b811515611c7a57fe5b0461010084015260e0830151611c9c846101200151849063ffffffff61267f16565b811515611ca557fe5b0461012084015260e083018290525b60008360e0015111611cc557600080fd5b600083610100015111611cd757600080fd5b611ce787846020015185516127ee565b905060008111611cf657600080fd5b808360e0015110611d075780611d0d565b8260e001515b61020084019081526000905111611d2357600080fd5b600190930192611ad7565b600080805b84821015611d90578482600101811515611d4957fe5b069050611d83848381518110611d5b57fe5b90602001906020020151858381518110611d7157fe5b906020019060200201518484876128e1565b9250600190910190611d33565b600091505b82821015610e0057611de4848381518110611dac57fe5b90602001906020020151858785600101811515611dc557fe5b0681518110611dd057fe5b9060200190602002015160008060006128e1565b50600190910190611d95565b6000806000806000611e00612a19565b600080600080600099506000985060649750600095505b8c861015612124578b8681518110611e2b57fe5b906020019060200201519450600093508461024001511515611e5e57600161016086015260ff88166101a0860152611f37565b611e6a8e8c87516127ee565b92508a600160a060020a03168560200151600160a060020a03161415611ea357611ea0856102000151849063ffffffff6129fa16565b92505b8a600160a060020a03168560400151600160a060020a03161415611ef0578b8d87600101811515611ed057fe5b0681518110611edb57fe5b90602001906020020151610200015196508693505b611f00838563ffffffff612a0916565b9150846102400151821015611f2257610240850182905260ff88166101a08601525b8461024001511515611f375760016101608601525b8461016001511515611f9b576000841115611f96578461024001518410611f71578461024001516102808601526000610240860152611f96565b6102808501849052611f8f846102408701519063ffffffff6129fa16565b6102408601525b612119565b89158015611fad575084610240015189105b15611fc45760019950611fc18e8c326127ee565b98505b8461024001518910612110578b8d87600101811515611fdf57fe5b0681518110611fea57fe5b9060200190602002015161020001519650846101400151156120475761204085610200015186610100015161202a8860e001518b9063ffffffff61267f16565b81151561203357fe5b049063ffffffff6129fa16565b9050612085565b6120828560e0015161206a8761010001518861020001519063ffffffff61267f16565b81151561207357fe5b8991900463ffffffff6129fa16565b90505b8760ff16856101a0015160ff16146120c1578760ff166120b4866101a00151839060ff1663ffffffff61267f16565b8115156120bd57fe5b0490505b846101400151156120d95761026085018190526120e2565b61028085018190525b6000811115612110576121018561024001518a9063ffffffff6129fa16565b98508461024001516102208601525b60006102408601525b600190950194611e17565b5050505050505050505050505050565b61213c612b41565b612144612b41565b61214c612b41565b600080600080600061215c612a19565b60008d60070260405180591061216f5750595b908082528060200260200182016040525098508d6002026040518059106121935750595b908082528060200260200182016040525097508d6007026040518059106121b75750595b908082528060200260200182016040525099506000965060009550600094508c60018f03815181106121e557fe5b9060200190602002015161028001519350600092505b8d83101561250c578c838151811061220f57fe5b9060200190602002015191508c8e8460010181151561222a57fe5b068151811061223557fe5b90602001906020020151610200015190508151600160a060020a031660010289888060010199508151811061226657fe5b6020908102909101810191909152820151600160a060020a031660010289888060010199508151811061229557fe5b602090810290910101526122b5846102008401519063ffffffff6129fa16565b60018801978a90815181106122c657fe5b602090810290910101526122e6610260830151859063ffffffff612a0916565b60018801978a90815181106122f757fe5b6020908102909101015261022082015160018801978a908151811061231857fe5b6020908102909101015261024082015160018801978a908151811061233957fe5b602090810290910101526060820151600160a060020a031660010289888060010199508151811061236657fe5b60209081029091010152610180820151600186019589908151811061238757fe5b602090810290910101526101408201516123a6578161020001516123a8565b805b60018601958990815181106123b957fe5b6020908102909101015261018082015160018701968b90815181106123da57fe5b602090810290910101528151600160a060020a03166001028a878060010198508151811061240457fe5b6020908102909101810191909152820151600160a060020a03166001028a878060010198508151811061243357fe5b6020908102909101015261020082015160018701968b908151811061245457fe5b6020908102909101015261022082015160018701968b908151811061247557fe5b6020908102909101015260006102408301511161249a578161022001516000036124a1565b8161024001515b60018701968b90815181106124b257fe5b602090810290910101526000610260830151116124d7578161028001516000036124de565b8161026001515b60018701968b90815181106124ef57fe5b6020908102909101015261028082015193506001909201916121fb565b8e600160a060020a03166373964787896040518263ffffffff1660e060020a0281526004018080602001828103825283818151815260200191508051906020019060200280838360005b8381101561256e578082015183820152602001612556565b5050505090500192505050600060405180830381600087803b151561259257600080fd5b5af1151561259f57600080fd5b5050508e600160a060020a0316634390a4f88c328f60148e60405160e060020a63ffffffff8816028152600160a060020a03808716600483019081528682166024840152908516604483015260ff8416606483015260a060848301908152909160a40183818151815260200191508051906020019060200280838360005b8381101561263557808201518382015260200161261d565b505050509050019650505050505050600060405180830381600087803b151561265d57600080fd5b5af1151561266a57600080fd5b50505050505050505050505095945050505050565b818102821580612699575081838281151561269657fe5b04145b15156126a457600080fd5b92915050565b600080600080600080600088519550600186116126c657600080fd5b600088116126d357600080fd5b60009450600093505b8584101561271057612703858a86815181106126f457fe5b90602001906020020151612a09565b94506001909301926126dc565b858581151561271b57fe5b04945084151561272e57600096506127c6565b60009250600093505b8584101561278c5788848151811061274b57fe5b9060200190602002015190508481116127665780850361276a565b8481035b915061277f8361277a848561267f565b612a09565b6001909401939250612737565b6001860385866127a561279f878d61267f565b8c61267f565b8115156127ae57fe5b048115156127b857fe5b048115156127c257fe5b0496505b50505050505092915050565b6000818310156127e35760006127e7565b8183035b9392505050565b6000828180600160a060020a03831663dd62ed3e868960405160e060020a63ffffffff8516028152600160a060020a03928316600482015291166024820152604401602060405180830381600087803b151561284957600080fd5b5af1151561285657600080fd5b5050506040518051925050600160a060020a0383166370a082318660405160e060020a63ffffffff8416028152600160a060020a039091166004820152602401602060405180830381600087803b15156128af57600080fd5b5af115156128bc57600080fd5b50505060405180519150508082106128d457806128d6565b815b979650505050505050565b8060006101c0870151612905886101e001518961020001519063ffffffff61267f16565b81151561290e57fe5b049050866101400151156129a257866101000151811115612971578661010001519050866101e0015161294d886101c00151839063ffffffff61267f16565b81151561295657fe5b046102008801908152600090511161296d57600080fd5b8491505b86610100015161298d828961012001519063ffffffff61267f16565b81151561299657fe5b046102408801526129d3565b8660e001516129c28861020001518961012001519063ffffffff61267f16565b8115156129cb57fe5b046102408801525b85610200015181116129ec5761020086018190526129f0565b8391505b5095945050505050565b6000828211156127e357600080fd5b818101828110156126a457600080fd5b6102a0604051908101604052806000600160a060020a031681526020016000600160a060020a031681526020016000600160a060020a031681526020016000600160a060020a031681526020016000600160a060020a03168152602001600081526020016000815260200160008152602001600081526020016000815260200160001515815260200160001515815260200160008019168152602001600060ff168152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081525090565b60e060405190810160405280612b05612b41565b8152602001612b12612b41565b8152602001612b1f612b41565b8152600060208201819052604082018190526060820181905260809091015290565b60206040519081016040526000815290565b60c06040519081016040526006815b6000815260200190600190039081612b6257905050905600a165627a7a72305820676652ba6775128bdad4ad0d8124da2e15596385bc71249f17b2db28e4f70c670029"
}